name: Release - Prepare

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 0.2.0)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    name: Prepare Release PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format. Use semver (e.g., 0.2.0 or 0.2.0-beta.1)"
            exit 1
          fi

      - name: Check tag doesn't already exist
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Bump version in config files
        run: |
          VERSION="${{ inputs.version }}"
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json
          jq --arg v "$VERSION" '.version = $v' src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json
          sed -i 's/^version = ".*"/version = "'"$VERSION"'"/' src-tauri/Cargo.toml
          # Update Cargo.lock to match new version
          cd src-tauri && cargo update -p mithril-vault
          echo "Updated versions to $VERSION"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: bump version to ${{ inputs.version }}"
          title: "chore: release v${{ inputs.version }}"
          body: |
            ## Release v${{ inputs.version }}

            This PR bumps the version to `${{ inputs.version }}` in preparation for release.

            ### Files Updated
            - `package.json`
            - `src-tauri/tauri.conf.json`
            - `src-tauri/Cargo.toml`
            - `src-tauri/Cargo.lock`

            ---
            ### Next Steps
            1. Wait for CI checks to pass
            2. Merge this PR
            3. Run the **"Release - Tag & Build"** workflow with version `${{ inputs.version }}`
          branch: release/v${{ inputs.version }}
          base: main
          labels: release

      - name: Summary
        run: |
          echo "## Release PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR #${{ steps.create-pr.outputs.pull-request-number }} has been created." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait for CI checks to pass" >> $GITHUB_STEP_SUMMARY
          echo "2. Merge the PR" >> $GITHUB_STEP_SUMMARY
          echo "3. Run **Release - Tag & Build** workflow with version \`${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
