name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 0.2.0)"
        required: true
        type: string
      draft:
        description: "Create as draft release"
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format. Use semver (e.g., 0.2.0 or 0.2.0-beta.1)"
            exit 1
          fi

      - name: Check tag doesn't already exist
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Bump version in config files
        run: |
          VERSION="${{ inputs.version }}"
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json
          jq --arg v "$VERSION" '.version = $v' src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json
          sed -i 's/^version = ".*"/version = "'"$VERSION"'"/' src-tauri/Cargo.toml
          echo "Updated versions to $VERSION"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: bump version to ${{ inputs.version }}"
          title: "chore: release v${{ inputs.version }}"
          body: |
            ## Release v${{ inputs.version }}

            This PR bumps the version to `${{ inputs.version }}` in preparation for release.

            ### Files Updated
            - `package.json`
            - `src-tauri/tauri.conf.json`
            - `src-tauri/Cargo.toml`

            ---
            *This PR was automatically created by the release workflow.*
            *Once merged, the release build will start automatically.*
          branch: release/v${{ inputs.version }}
          base: main
          labels: release

      - name: Enable auto-merge
        if: steps.create-pr.outputs.pull-request-number
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} --auto --squash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for PR to be merged
        id: auto-merge
        if: steps.create-pr.outputs.pull-request-number
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
          echo "Waiting for PR #$PR_NUMBER to be merged..."

          for i in {1..60}; do
            STATE=$(gh pr view $PR_NUMBER --json state --jq '.state')
            if [ "$STATE" == "MERGED" ]; then
              echo "PR #$PR_NUMBER merged successfully!"
              exit 0
            elif [ "$STATE" == "CLOSED" ]; then
              echo "::error::PR #$PR_NUMBER was closed without merging"
              exit 1
            fi
            echo "Waiting... (attempt $i/60)"
            sleep 10
          done

          echo "::error::Timeout waiting for PR to be merged"
          exit 1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        run: |
          git fetch origin main
          git checkout main
          git pull origin main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ inputs.version }}" -m "Release v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"
          echo "Tag v${{ inputs.version }} created and pushed"

      - name: Trigger release build
        run: |
          gh api repos/${{ github.repository }}/dispatches \
            -f event_type=release-build \
            -f client_payload='{"version":"${{ inputs.version }}","draft":${{ inputs.draft }}}'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
